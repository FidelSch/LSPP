name: CI

on:
  pull_request:
    branches: [master, develop]
  push:
    branches: [master]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 22.04 with GCC
          - os: ubuntu-22.04
            compiler: gcc-11
            cc: gcc-11
            cxx: g++-11

          - os: ubuntu-22.04
            compiler: gcc-12
            cc: gcc-12
            cxx: g++-12

          # Ubuntu 24.04 with GCC
          - os: ubuntu-24.04
            compiler: gcc-13
            cc: gcc-13
            cxx: g++-13

          # Ubuntu 22.04 with Clang
          - os: ubuntu-22.04
            compiler: clang-15
            cc: clang-15
            cxx: clang++-15

          - os: ubuntu-22.04
            compiler: clang-16
            cc: clang-16
            cxx: clang++-16

          - os: macos-14
            compiler: clang
            cc: clang
            cxx: clang++

          # macOS with Apple Clang
          - os: macos-15
            compiler: clang
            cc: clang
            cxx: clang++

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

          # Install specific compiler version
          COMPILER="${{ matrix.compiler }}"
          if [[ "$COMPILER" == gcc-* ]]; then
            sudo apt-get install -y ${{ matrix.cxx }}
          elif [[ "$COMPILER" == clang-* ]]; then
            VERSION="${COMPILER#clang-}"
            wget https://apt.llvm.org/llvm.sh
            chmod +x llvm.sh
            sudo ./llvm.sh "$VERSION" || true
            sudo apt-get install -y ${{ matrix.cxx }} clang-tools-${VERSION}
          fi

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ninja

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "3.30.x"

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -G Ninja \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

      - name: Build
        run: cmake --build build --config Release

      - name: Run tests
        working-directory: build
        run: |
          # Retry tests up to 3 times on failure (handles intermittent memory allocation issues)
          for i in 1 2 3; do
            if ctest --output-on-failure --verbose -C Release --repeat until-pass:3; then
              echo "Tests passed"
              exit 0
            else
              echo "Tests failed on attempt $i"
              if [ $i -lt 3 ]; then
                echo "Retrying full suite..."
                sleep 2
              fi
            fi
          done
          echo "Tests failed after 3 attempts"
          exit 1

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            build/main
            build/libLSPP.so*
            build/*.so.*
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            build/Testing/Temporary/LastTest.log
          retention-days: 7
